<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closing count</title>
    <style>
        :root {
            /* Light Mode */
            --bg: #f5f7f9; --text: #1a1a1a; --border: #cfd8dc;
            --card-bg: #ffffff; --input-bg: #ffffff; --sub-text: #546e7a;
            --primary: #1565c0; --secondary: #2e7d32; --danger: #c62828; --warning: #ef6c00;
            --total-box: #263238; --total-text: #ffffff;
            --shadow: rgba(0,0,0,0.15);
        }

        body.dark-mode {
            /* Dark Mode */
            --bg: #101214; --text: #eceff1; --border: #37474f;
            --card-bg: #1c1f24; --input-bg: #263238; --sub-text: #90a4ae;
            --primary: #64b5f6; --secondary: #81c784; --danger: #e57373; --warning: #ffb74d;
            --total-box: #000000;
            --shadow: rgba(0,0,0,0.4);
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg); 
            margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh;
            color: var(--text); transition: all 0.3s ease;
        }
        
        .container { 
            background: var(--card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px var(--shadow); 
            max-width: 1100px; width: 95%; display: grid; grid-template-columns: 1fr 360px; gap: 25px; position: relative;
        }

        .top-controls { position: absolute; top: -45px; right: 0; display: flex; align-items: center; gap: 20px; }
        .theme-switch { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: bold; color: var(--sub-text); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .lang-btn { cursor: pointer; font-size: 0.9rem; border: none; background: none; color: var(--sub-text); font-weight: bold; text-transform: uppercase; }
        .lang-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .main-panel { display: flex; flex-direction: column; gap: 20px; }
        .card { padding: 20px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-bg); }
        .title { font-size: 0.9rem; font-weight: 800; color: var(--sub-text); text-transform: uppercase; margin-bottom: 15px; border-bottom: 3px solid var(--primary); padding-bottom: 5px; }

        .pos-container { display: flex; gap: 20px; align-items: stretch; width: 100%; }
        .pos-column { flex: 1; display: flex; flex-direction: column; }
        .pos-column label { font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; color: var(--sub-text); }

        #pos-amount, .diff-result {
            height: 85px; box-sizing: border-box; border-radius: 12px;
            border: 2px solid var(--border); display: flex; flex-direction: column;
            justify-content: center; transition: all 0.3s ease; width: 100%;
        }

        #pos-amount {
            padding: 0 15px; font-size: 2rem; font-weight: 600;
            background: var(--input-bg); color: var(--text); text-align: right;
        }

        .diff-result { align-items: center; text-align: center; }
        .diff-result span:first-child { font-size: 0.7rem; text-transform: uppercase; margin-bottom: 2px; opacity: 0.8; }
        .diff-result span:last-child { font-size: 1.7rem; font-weight: 800; }

        .diff-result.over { background: rgba(46, 125, 50, 0.1); color: var(--secondary); border-color: var(--secondary); }
        .diff-result.short { background: rgba(198, 40, 40, 0.1); color: var(--danger); border-color: var(--danger); }
        .diff-result.neutral { background: rgba(128, 128, 128, 0.08); color: var(--sub-text); }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); }
        .row label { font-size: 1.1rem; font-weight: 700; width: 50px; }
        
        input { 
            width: 85px; padding: 10px; border: 2px solid var(--border); border-radius: 8px; 
            text-align: right; font-size: 1.1rem; font-weight: 600; background: var(--input-bg); color: var(--text);
        }

        .side-panel { display: flex; flex-direction: column; gap: 20px; }
        .summary-box { background: var(--total-box); color: var(--total-text); padding: 25px; border-radius: 14px; text-align: center; }
        .report-list { list-style: none; padding: 0; margin: 0; font-size: 1rem; }
        .report-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
        
        .btn-reset { width: 100%; padding: 15px; cursor: pointer; background: transparent; border: 2px solid var(--danger); border-radius: 10px; font-weight: 800; color: var(--danger); font-size: 1rem; transition: 0.3s; }
        .btn-reset:hover { background: var(--danger); color: white; }

        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } .top-controls { top: -65px; flex-direction: column; align-items: flex-end; gap: 10px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="top-controls">
        <div class="theme-switch">
            <span id="t-theme-label">Dark Mode</span>
            <label class="switch">
                <input type="checkbox" id="mode-toggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
        <div>
            <button class="lang-btn" id="btn-es" onclick="setLang('es')">ESPAÑOL</button>
            <button class="lang-btn active" id="btn-en" onclick="setLang('en')">ENGLISH</button>
        </div>
    </div>

    <div class="main-panel">
        <div class="card" style="border-top: 6px solid var(--primary);">
            <div class="title" id="t-pos-title">Sales Balance</div>
            <div class="pos-container">
                <div class="pos-column">
                    <label id="t-pos-label">REPORTED POS SALES ($)</label>
                    <input type="number" id="pos-amount" placeholder="0.00" step="0.01" onkeydown="blockInvalidChars(event, true)" oninput="secureCalculate(this, true)">
                </div>
                <div class="pos-column">
                    <label id="t-diff-label">Difference Status</label>
                    <div id="diff-display" class="diff-result neutral">
                        <span id="t-diff-sub">Status</span>
                        <span id="diff-value">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-grid">
            <div class="card">
                <div class="title" id="t-bills-title">Bills</div>
                <div id="bills-area"></div>
            </div>
            <div class="card">
                <div class="title" id="t-coins-title">Coins & Rolls</div>
                <div id="coins-area"></div>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <div class="summary-box">
            <div style="font-size: 0.9rem; opacity: 0.8; letter-spacing: 1.5px;" id="t-real-cash">TOTAL IN TILL</div>
            <div id="grand-total" style="font-size: 3rem; font-weight: 900; margin: 10px 0; font-family: 'Consolas', monospace;">$0.00</div>
            <div style="display:flex; justify-content:space-between; align-items:center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 15px;">
                <span style="font-size: 0.9rem; font-weight: bold;" id="t-fondo-fijo">FIXED FLOAT:</span>
                <input type="number" id="target-safe" value="250" style="width:100px; font-size: 1.1rem; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); text-align: right;" onkeydown="blockInvalidChars(event, true)" oninput="secureCalculate(this, true)">
            </div>
        </div>

        <div class="card" style="border-left: 6px solid var(--warning); flex-grow: 1;">
            <div class="title" style="color:var(--warning)" id="t-need-title">Change Guide (Limits)</div>
            <ul id="bank-need-list" class="report-list"></ul>
        </div>

        <button class="btn-reset" id="t-btn-reset" onclick="resetForm()">CLEAR DATA</button>
    </div>
</div>

<script>
    let currentLang = 'en';
    const LIMIT = 99999; // Nuevo límite ajustado
    const i18n = {
        es: {
            posTitle: "Cuadre de Ventas", posLabel: "VENTAS REPORTADAS POS ($)",
            diffLabel: "Estado de Diferencia", diffSub: "Balance", 
            billsTitle: "Billetes", coinsTitle: "Monedas y Rollos",
            realCash: "TOTAL EN CAJA", fondoFijo: "FONDO FIJO:",
            needTitle: "Guía de Cambio (Máximos)", btnReset: "BORRAR TODO EL CONTEO",
            confirmReset: "¿Deseas borrar todos los datos?", square: "CUADRADO", 
            over: "SOBRA", short: "FALTA", missing: "Faltan", target: "Meta: ", 
            ok: "✅ OK", theme: "Modo Oscuro"
        },
        en: {
            posTitle: "Sales Balance", posLabel: "REPORTED POS SALES ($)",
            diffLabel: "Difference Status", diffSub: "Status",
            billsTitle: "Bills", coinsTitle: "Coins & Rolls",
            realCash: "TOTAL IN TILL", fondoFijo: "FIXED FLOAT:",
            needTitle: "Change Guide (Limits)", btnReset: "CLEAR ALL DATA",
            confirmReset: "Are you sure you want to clear all data?", square: "BALANCED", 
            over: "OVER", short: "SHORT", missing: "Missing", target: "Target: ", 
            ok: "✅ OK", theme: "Dark Mode"
        }
    };

    const bills = [100, 50, 20, 10, 5, 2, 1];
    const coins = [0.50, 0.25, 0.10, 0.05, 0.01];
    const rollCap = { 0.50: 20, 0.25: 40, 0.10: 50, 0.05: 40, 0.01: 50 };
    const maxLimits = { 20: 2, 10: 4, 5: 16, 1: 50 };

    function blockInvalidChars(e, allowDecimal) {
        let keys = ["e", "E", "-", "+"];
        if (!allowDecimal) keys.push(".");
        if (keys.includes(e.key)) e.preventDefault();
    }

    function secureCalculate(input, allowDecimal) {
        let val = input.value;
        if (val < 0) input.value = 0;
        if (val > LIMIT) input.value = LIMIT;

        if (!allowDecimal && val.includes('.')) {
            input.value = Math.floor(parseFloat(val));
        }

        if (allowDecimal && val.includes('.')) {
            const parts = val.split('.');
            if (parts[1].length > 2) {
                input.value = parseFloat(val).toFixed(2);
            }
        }
        calculate();
    }

    function initTheme() {
        const toggle = document.getElementById('mode-toggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            document.body.classList.add('dark-mode');
            toggle.checked = true;
        }
    }

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    function setLang(lang) {
        currentLang = lang;
        document.getElementById('btn-es').classList.toggle('active', lang === 'es');
        document.getElementById('btn-en').classList.toggle('active', lang === 'en');
        const t = i18n[lang];
        document.getElementById('t-pos-title').innerText = t.posTitle;
        document.getElementById('t-pos-label').innerText = t.posLabel;
        document.getElementById('t-diff-label').innerText = t.diffLabel;
        document.getElementById('t-diff-sub').innerText = t.diffSub;
        document.getElementById('t-bills-title').innerText = t.billsTitle;
        document.getElementById('t-coins-title').innerText = t.coinsTitle;
        document.getElementById('t-real-cash').innerText = t.realCash;
        document.getElementById('t-fondo-fijo').innerText = t.fondoFijo;
        document.getElementById('t-need-title').innerText = t.needTitle;
        document.getElementById('t-btn-reset').innerText = t.btnReset;
        document.getElementById('t-theme-label').innerText = t.theme;
        calculate();
    }

    function setup() {
        const bArea = document.getElementById('bills-area');
        bills.forEach(v => {
            bArea.innerHTML += `<div class="row"><label>$${v}</label><input type="number" class="qty" data-val="${v}" min="0" max="${LIMIT}" onkeydown="blockInvalidChars(event, false)" onfocus="this.select()" oninput="secureCalculate(this, false)"></div>`;
        });
        const cArea = document.getElementById('coins-area');
        coins.forEach(v => {
            cArea.innerHTML += `<div class="row"><label>${v*100}¢</label><div style="display:flex; gap:6px;"><input type="number" class="qty" data-val="${v}" min="0" max="${LIMIT}" onkeydown="blockInvalidChars(event, false)" onfocus="this.select()" oninput="secureCalculate(this, false)"><input type="number" class="roll-qty" data-val="${v}" min="0" max="${LIMIT}" placeholder="R" onkeydown="blockInvalidChars(event, false)" onfocus="this.select()" oninput="secureCalculate(this, false)"></div></div>`;
        });
        initTheme();
        setLang('en');
    }

    function calculate() {
        let total = 0;
        let inventory = {};
        document.querySelectorAll('.qty').forEach(i => {
            let v = parseFloat(i.dataset.val), q = parseInt(i.value) || 0;
            inventory[v] = (inventory[v] || 0) + q;
        });
        document.querySelectorAll('.roll-qty').forEach(i => {
            let v = parseFloat(i.dataset.val), r = parseInt(i.value) || 0;
            inventory[v] = (inventory[v] || 0) + (r * rollCap[v]);
        });
        [...bills, ...coins].forEach(v => { total += v * (inventory[v] || 0); });
        document.getElementById('grand-total').innerText = `$${total.toFixed(2)}`;
        
        const pos = parseFloat(document.getElementById('pos-amount').value) || 0;
        const target = parseFloat(document.getElementById('target-safe').value) || 0;
        const diff = (total - target) - pos;
        const diffBox = document.getElementById('diff-display');
        const diffVal = document.getElementById('diff-value');
        const t = i18n[currentLang];

        if (pos === 0 && total === 0) {
            diffBox.className = "diff-result neutral"; diffVal.innerText = "$0.00";
        } else if (Math.abs(diff) < 0.01) {
            diffBox.className = "diff-result over"; diffVal.innerText = t.square;
        } else if (diff > 0) {
            diffBox.className = "diff-result over"; diffVal.innerText = `${t.over} $${diff.toFixed(2)}`;
        } else {
            diffBox.className = "diff-result short"; diffVal.innerText = `${t.short} $${Math.abs(diff).toFixed(2)}`;
        }
        renderGuide(inventory);
    }

    function renderGuide(inventory) {
        const needList = document.getElementById('bank-need-list');
        const t = i18n[currentLang];
        needList.innerHTML = "";
        Object.keys(maxLimits).sort((a,b)=>b-a).forEach(v => {
            let actual = inventory[v] || 0;
            let max = maxLimits[v];
            if(actual < max) {
                needList.innerHTML += `<li><span>$${v}</span> <span>${t.target}<b>${max}</b> <small>(${t.missing}: <span class="missing-qty">${max-actual}</span>)</small></span></li>`;
            } else {
                needList.innerHTML += `<li><span>$${v}</span> <small style="color:var(--secondary)">${t.ok}</small></li>`;
            }
        });
    }

    function resetForm() {
        if(confirm(i18n[currentLang].confirmReset)) {
            document.querySelectorAll('input[type="number"]').forEach(i => { if(i.id !== 'target-safe') i.value = ''; });
            calculate();
        }
    }
    setup();
</script>
</body>
</html>