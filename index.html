<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closing Count Pro</title>
    <style>
        :root {
            /* Colores Originales (Intactos) */
            --bg: #f5f7f9; --text: #1a1a1a; --border: #cfd8dc;
            --card-bg: #ffffff; --input-bg: #ffffff; --sub-text: #546e7a;
            --primary: #1565c0; --secondary: #2e7d32; --danger: #c62828; --warning: #ef6c00;
            --purple: #7b1fa2; --info: #0288d1;
            --total-box: #263238; --total-text: #ffffff;
            --shadow: rgba(0,0,0,0.15); --pattern: rgba(0,0,0,0.05);
        }

        body.dark-mode {
            --bg: #101214; --text: #eceff1; --border: #37474f;
            --card-bg: #1c1f24; --input-bg: #263238; --sub-text: #90a4ae;
            --primary: #64b5f6; --secondary: #81c784; --danger: #e57373; --warning: #ffb74d;
            --purple: #ce93d8; --info: #29b6f6;
            --total-box: #000000;
            --shadow: rgba(0,0,0,0.4); --pattern: rgba(255,255,255,0.05);
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg); 
            background-image: 
                linear-gradient(45deg, var(--pattern) 25%, transparent 25%, transparent 75%, var(--pattern) 75%), 
                linear-gradient(-45deg, var(--pattern) 25%, transparent 25%, transparent 75%, var(--pattern) 75%);
            background-size: 40px 40px;
            margin: 0; 
            height: 100vh; /* Pantalla completa */
            width: 100vw;
            overflow: hidden; /* Sin scroll */
            display: flex; align-items: center; justify-content: center;
            color: var(--text); transition: all 0.3s ease;
        }
        
        .container { 
            background: var(--card-bg); 
            /* COMPACTADO: Menos padding externo */
            padding: 15px; 
            border-radius: 0; border: 2px solid var(--border);
            box-shadow: 12px 12px 0 var(--shadow); 
            max-width: 1100px; width: 95%; 
            /* COMPACTADO: Gap reducido de 25px a 12px */
            display: grid; grid-template-columns: 1fr 360px; gap: 12px; 
            position: relative;
            max-height: 98vh; /* Seguridad */
        }

        .top-controls { position: absolute; top: -35px; right: 0; display: flex; align-items: center; gap: 15px; }
        .theme-switch { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: bold; color: var(--sub-text); }
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 0; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 0; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .lang-btn { cursor: pointer; font-size: 0.8rem; border: none; background: none; color: var(--sub-text); font-weight: bold; text-transform: uppercase; }
        .lang-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .main-panel { display: flex; flex-direction: column; gap: 12px; height: 100%; }
        /* COMPACTADO: Padding interno de tarjeta reducido */
        .card { padding: 15px; border-radius: 0; border: 1px solid var(--border); background: var(--card-bg); box-shadow: 6px 6px 0 var(--shadow); display: flex; flex-direction: column; }
        
        /* COMPACTADO: Margen de títulos reducido */
        .title { font-size: 0.8rem; font-weight: 800; color: var(--sub-text); text-transform: uppercase; margin-bottom: 8px; border-bottom: 3px solid var(--primary); padding-bottom: 4px; }

        .pos-container { display: flex; gap: 15px; align-items: stretch; width: 100%; }
        .pos-column { flex: 1; display: flex; flex-direction: column; }
        .pos-column label { font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; color: var(--sub-text); }

        #pos-amount, .diff-result {
            /* COMPACTADO: Altura reducida de 85px a 60px */
            height: 60px; 
            box-sizing: border-box; border-radius: 0;
            border: 2px solid var(--border); display: flex; flex-direction: column;
            justify-content: center; transition: all 0.3s ease; width: 100%; box-shadow: 4px 4px 0 var(--shadow);
        }

        #pos-amount {
            padding: 0 10px; font-size: 1.8rem; font-weight: 600;
            background: var(--input-bg); color: var(--text); text-align: right;
        }

        .diff-result { align-items: center; text-align: center; }
        .diff-result span:first-child { font-size: 0.65rem; text-transform: uppercase; margin-bottom: 0; opacity: 0.8; }
        .diff-result span:last-child { font-size: 1.5rem; font-weight: 800; }

        .diff-result.over { background: rgba(46, 125, 50, 0.1); color: var(--secondary); border-color: var(--secondary); }
        .diff-result.short { background: rgba(198, 40, 40, 0.1); color: var(--danger); border-color: var(--danger); }
        .diff-result.neutral { background: rgba(128, 128, 128, 0.08); color: var(--sub-text); }

        /* COMPACTADO: Gap de grid reducido */
        .input-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
            flex-grow: 1; /* Ocupar espacio restante */
            min-height: 0; /* Permitir scroll interno si es crítico */
        }
        
        /* --- AQUÍ ESTÁ EL CAMBIO IMPORTANTE --- */
        .input-grid .card {
            overflow-y: auto; 
            justify-content: flex-start; /* CAMBIO: Antes era space-between. Esto sube el contenido. */
            gap: 10px; /* CAMBIO: Añadido espacio controlado entre título y contenido */
        }

        /* COMPACTADO: Padding vertical de filas reducido drásticamente */
        .row { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border); }
        .row label { font-size: 1rem; font-weight: 700; width: 50px; }
        
        input { 
            width: 75px; padding: 6px; border: 2px solid var(--border); border-radius: 0; 
            text-align: right; font-size: 1rem; font-weight: 600; background: var(--input-bg); color: var(--text);
            box-shadow: 4px 4px 0 var(--shadow); transition: transform 0.2s, box-shadow 0.2s;
        }
        input:focus { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--shadow); outline: none; border-color: var(--primary); }

        .side-panel { display: flex; flex-direction: column; gap: 12px; height: 100%; }
        .summary-box { background: var(--total-box); color: var(--total-text); padding: 15px; border-radius: 0; text-align: center; box-shadow: 8px 8px 0 var(--shadow); flex-shrink: 0; }
        
        /* Change Breaker Compacto */
        .change-input-group { display: flex; gap: 8px; margin-bottom: 5px; }
        .change-input-group input { width: 100%; }
        .change-suggestion { display: flex; justify-content: space-between; font-weight: bold; padding: 3px 0; border-bottom: 1px dotted var(--border); font-size: 0.85rem; }
        
        .limits-card { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; }
        .report-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; overflow-y: auto; }
        .report-list li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border); }
        
        .btn-reset { width: 100%; padding: 12px; cursor: pointer; background: transparent; border: 2px solid var(--danger); border-radius: 0; font-weight: 800; color: var(--danger); font-size: 0.9rem; transition: 0.2s; box-shadow: 6px 6px 0 var(--danger); margin-top: auto; flex-shrink: 0; }
        .btn-reset:hover { background: var(--danger); color: white; transform: translate(4px, 4px); box-shadow: 2px 2px 0 var(--danger); }
        .btn-reset:active { transform: translate(6px, 6px); box-shadow: 0 0 0 var(--danger); }

        /* Media Queries básicas para Móvil (cuando no sea escritorio) */
        @media (max-width: 900px) {
            body { height: auto; overflow: auto; align-items: flex-start; padding: 60px 0 40px 0; }
            .container { grid-template-columns: 1fr; width: 90%; height: auto; max-height: none; }
            .top-controls { top: -50px; flex-direction: column; align-items: flex-end; gap: 10px; }
            .side-panel { height: auto; }
            .input-grid { height: auto; flex-grow: 0; }
        }

        @media (max-width: 600px) {
            .container { padding: 10px; width: 94%; }
            .input-grid { grid-template-columns: 1fr; }
            .pos-container { flex-direction: column; }
            .diff-result { height: auto; padding: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-controls">
        <div class="theme-switch">
            <span id="t-theme-label">Dark Mode</span>
            <label class="switch">
                <input type="checkbox" id="mode-toggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
        <div>
            <button class="lang-btn" id="btn-es" onclick="setLang('es')">ESPAÑOL</button>
            <button class="lang-btn active" id="btn-en" onclick="setLang('en')">ENGLISH</button>
        </div>
    </div>

    <div class="main-panel">
        <div class="card" style="border-top: 6px solid var(--primary); flex-shrink: 0;">
            <div class="title" id="t-pos-title">Sales Balance</div>
            <div class="pos-container">
                <div class="pos-column">
                    <label id="t-pos-label">REPORTED POS SALES ($)</label>
                    <input type="number" id="pos-amount" placeholder="0.00" step="0.01" onkeydown="blockInvalidChars(event, true)" oninput="secureCalculate(this, true)">
                </div>
                <div class="pos-column">
                    <label id="t-diff-label">Difference Status</label>
                    <div id="diff-display" class="diff-result neutral">
                        <span id="t-diff-sub">Status</span>
                        <span id="diff-value">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-grid">
            <div class="card">
                <div class="title" id="t-bills-title">Bills</div>
                <div id="bills-area"></div>
            </div>
            <div class="card">
                <div class="title" id="t-coins-title">Coins & Rolls</div>
                <div id="coins-area"></div>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <div class="summary-box">
            <div style="font-size: 0.8rem; opacity: 0.8; letter-spacing: 1.5px;" id="t-real-cash">TOTAL IN TILL</div>
            <div id="grand-total" style="font-size: 2.5rem; font-weight: 900; margin: 5px 0; font-family: 'Consolas', monospace;">$0.00</div>
            <div style="display:flex; justify-content:space-between; align-items:center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 5px;">
                <span style="font-size: 0.8rem; font-weight: bold;" id="t-fondo-fijo">FIXED FLOAT:</span>
                <input type="number" id="target-safe" value="250" style="width:90px; font-size: 1rem; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); text-align: right; padding: 5px;" onkeydown="blockInvalidChars(event, true)" oninput="secureCalculate(this, true)">
            </div>
        </div>

        <div class="card" style="border-left: 6px solid var(--purple); flex-shrink: 0;">
            <div class="title" style="color:var(--purple)" id="t-breaker-title">Change Breaker</div>
            <div class="change-input-group">
                <input type="number" id="break-amount" placeholder="Input Amount" onkeydown="blockInvalidChars(event, true)" oninput="calculateChangeSuggestion()" style="width:100%;">
            </div>
            <div id="break-result">
                <small style="color:var(--sub-text)" id="t-breaker-desc">Enter amount to break down.</small>
            </div>
        </div>

        <div class="card limits-card" style="border-left: 6px solid var(--warning);">
            <div class="title" style="color:var(--warning)" id="t-need-title">Change Guide (Limits)</div>
            <ul id="bank-need-list" class="report-list"></ul>
        </div>

        <button class="btn-reset" id="t-btn-reset" onclick="resetForm()">CLEAR DATA</button>
    </div>
</div>

<script>
    let currentLang = 'en';
    const LIMIT = 99999;
    
    // Configuración Original
    const bills = [100, 50, 20, 10, 5, 2, 1];
    const coins = [0.50, 0.25, 0.10, 0.05, 0.01];
    const rollCap = { 0.50: 20, 0.25: 40, 0.10: 50, 0.05: 40, 0.01: 50 };
    const maxLimits = { 20: 2, 10: 4, 5: 16, 1: 50 };
    
    // Lógica Change Breaker (Prioridad $5 y $1)
    const breakdownOrder = [
        { val: 5, batch: 1 },  
        { val: 1, batch: 1 }, 
        { val: 10, batch: 1 },
        { val: 20, batch: 1 }
    ];

    const i18n = {
        es: {
            posTitle: "Cuadre de Ventas", posLabel: "VENTAS REPORTADAS POS ($)",
            diffLabel: "Estado de Diferencia", diffSub: "Balance", 
            billsTitle: "Billetes", coinsTitle: "Monedas y Rollos",
            realCash: "TOTAL EN CAJA", fondoFijo: "FONDO FIJO:",
            needTitle: "Guía de Cambio (Máximos)", btnReset: "BORRAR TODO EL CONTEO",
            confirmReset: "¿Deseas borrar todos los datos?", square: "CUADRADO", 
            over: "SOBRA", short: "FALTA", missing: "Faltan", target: "Meta: ", 
            ok: "✅ OK", theme: "Modo Oscuro",
            breakerTitle: "Desglose de Billetes", breakerDesc: "Ingresa monto para desglosar."
        },
        en: {
            posTitle: "Sales Balance", posLabel: "REPORTED POS SALES ($)",
            diffLabel: "Difference Status", diffSub: "Status",
            billsTitle: "Bills", coinsTitle: "Coins & Rolls",
            realCash: "TOTAL IN TILL", fondoFijo: "FIXED FLOAT:",
            needTitle: "Change Guide (Limits)", btnReset: "CLEAR ALL DATA",
            confirmReset: "Are you sure you want to clear all data?", square: "BALANCED", 
            over: "OVER", short: "SHORT", missing: "Missing", target: "Target: ", 
            ok: "✅ OK", theme: "Dark Mode",
            breakerTitle: "Change Breaker", breakerDesc: "Enter amount to break down."
        }
    };

    let currentInventory = {};

    function blockInvalidChars(e, allowDecimal) {
        let keys = ["e", "E", "-", "+"];
        if (!allowDecimal) keys.push(".");
        if (keys.includes(e.key)) e.preventDefault();
    }

    function secureCalculate(input, allowDecimal) {
        let val = input.value;
        if (val < 0) input.value = 0;
        if (val > LIMIT) input.value = LIMIT;

        if (!allowDecimal && val.includes('.')) {
            input.value = Math.floor(parseFloat(val));
        }

        if (allowDecimal && val.includes('.')) {
            const parts = val.split('.');
            if (parts[1].length > 2) {
                input.value = parseFloat(val).toFixed(2);
            }
        }
        if (input.id === 'target-safe') localStorage.setItem('cashApp_target', val);
        calculate();
    }

    function initTheme() {
        const toggle = document.getElementById('mode-toggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            document.body.classList.add('dark-mode');
            toggle.checked = true;
        }
    }

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    function setLang(lang) {
        currentLang = lang;
        document.getElementById('btn-es').classList.toggle('active', lang === 'es');
        document.getElementById('btn-en').classList.toggle('active', lang === 'en');
        const t = i18n[lang];
        document.getElementById('t-pos-title').innerText = t.posTitle;
        document.getElementById('t-pos-label').innerText = t.posLabel;
        document.getElementById('t-diff-label').innerText = t.diffLabel;
        document.getElementById('t-diff-sub').innerText = t.diffSub;
        document.getElementById('t-bills-title').innerText = t.billsTitle;
        document.getElementById('t-coins-title').innerText = t.coinsTitle;
        document.getElementById('t-real-cash').innerText = t.realCash;
        document.getElementById('t-fondo-fijo').innerText = t.fondoFijo;
        document.getElementById('t-need-title').innerText = t.needTitle;
        document.getElementById('t-btn-reset').innerText = t.btnReset;
        document.getElementById('t-theme-label').innerText = t.theme;
        
        document.getElementById('t-breaker-title').innerText = t.breakerTitle;
        if(!document.getElementById('break-amount').value) {
            document.getElementById('t-breaker-desc').innerText = t.breakerDesc;
        } else {
            calculateChangeSuggestion(); 
        }

        calculate();
    }

    function setup() {
        const bArea = document.getElementById('bills-area');
        bills.forEach(v => {
            bArea.innerHTML += `<div class="row"><label>$${v}</label><input type="number" class="qty" data-val="${v}" min="0" max="${LIMIT}" onkeydown="blockInvalidChars(event, false)" onfocus="this.select()" oninput="secureCalculate(this, false)"></div>`;
        });
        const cArea = document.getElementById('coins-area');
        coins.forEach(v => {
            cArea.innerHTML += `<div class="row"><label>${v*100}¢</label><div style="display:flex; gap:6px;"><input type="number" class="qty" data-val="${v}" min="0" max="${LIMIT}" onkeydown="blockInvalidChars(event, false)" onfocus="this.select()" oninput="secureCalculate(this, false)"><input type="number" class="roll-qty" data-val="${v}" min="0" max="${LIMIT}" placeholder="R" onkeydown="blockInvalidChars(event, false)" onfocus="this.select()" oninput="secureCalculate(this, false)"></div></div>`;
        });
        
        const savedTarget = localStorage.getItem('cashApp_target');
        if (savedTarget) document.getElementById('target-safe').value = savedTarget;

        initTheme();
        setLang('en');
    }

    function calculate() {
        let total = 0;
        let inventory = {};
        document.querySelectorAll('.qty').forEach(i => {
            let v = parseFloat(i.dataset.val), q = parseInt(i.value) || 0;
            inventory[v] = (inventory[v] || 0) + q;
        });
        document.querySelectorAll('.roll-qty').forEach(i => {
            let v = parseFloat(i.dataset.val), r = parseInt(i.value) || 0;
            inventory[v] = (inventory[v] || 0) + (r * rollCap[v]);
        });
        [...bills, ...coins].forEach(v => { total += v * (inventory[v] || 0); });
        document.getElementById('grand-total').innerText = `$${total.toFixed(2)}`;
        
        const pos = parseFloat(document.getElementById('pos-amount').value) || 0;
        const target = parseFloat(document.getElementById('target-safe').value) || 0;
        const diff = (total - target) - pos;
        const diffBox = document.getElementById('diff-display');
        const diffVal = document.getElementById('diff-value');
        const t = i18n[currentLang];

        if (pos === 0 && total === 0) {
            diffBox.className = "diff-result neutral"; diffVal.innerText = "$0.00";
        } else if (Math.abs(diff) < 0.01) {
            diffBox.className = "diff-result over"; diffVal.innerText = t.square;
        } else if (diff > 0) {
            diffBox.className = "diff-result over"; diffVal.innerText = `${t.over} $${diff.toFixed(2)}`;
        } else {
            diffBox.className = "diff-result short"; diffVal.innerText = `${t.short} $${Math.abs(diff).toFixed(2)}`;
        }
        renderGuide(inventory);
        
        const breakInput = document.getElementById('break-amount');
        if(breakInput.value) calculateChangeSuggestion();
    }

    // LÓGICA DE DESGLOSE (CONSOLIDADA)
    function calculateChangeSuggestion() {
        const input = document.getElementById('break-amount');
        const resDiv = document.getElementById('break-result');
        let amount = parseFloat(input.value);
        const t = i18n[currentLang];

        if (!amount || amount <= 0) {
            resDiv.innerHTML = `<small style="color:var(--sub-text)">${t.breakerDesc}</small>`;
            return;
        }

        let cents = Math.round(amount * 100);
        let totalCounts = {}; 

        // 1. Llenar Huecos de Guía
        Object.keys(maxLimits).sort((a,b) => b-a).forEach(k => {
            let denom = parseFloat(k);
            let denomCents = Math.round(denom * 100);
            let currentQty = currentInventory[denom] || 0;
            let targetQty = maxLimits[denom];
            let missing = Math.max(0, targetQty - currentQty);

            if (missing > 0 && cents >= denomCents) {
                let affordable = Math.floor(cents / denomCents);
                let take = Math.min(missing, affordable);
                if (take > 0) {
                    totalCounts[denom] = (totalCounts[denom] || 0) + take;
                    cents -= (take * denomCents);
                }
            }
        });

        // 2. Usar Resto (Prioridad 5 y 1)
        if (cents > 0) {
            breakdownOrder.forEach(item => {
                let itemCost = item.val * item.batch * 100;
                if (cents >= itemCost) {
                    let batches = Math.floor(cents / itemCost);
                    let totalBills = batches * item.batch;
                    if (totalBills > 0) {
                        totalCounts[item.val] = (totalCounts[item.val] || 0) + totalBills;
                        cents -= (batches * itemCost);
                    }
                }
            });
        }

        // 3. Renderizar Consolidado
        let html = "";
        let hasItems = false;
        
        // Orden descendente
        Object.keys(totalCounts).sort((a,b) => parseFloat(b) - parseFloat(a)).forEach(denom => {
            let count = totalCounts[denom];
            if(count > 0) {
                hasItems = true;
                html += `<div class="change-suggestion">
                            <span>${count} x $${denom}</span>
                         </div>`;
            }
        });

        if(cents > 0) {
            html += `<div style="color:var(--danger); font-size:0.8rem; margin-top:5px; font-weight:bold;">⚠️ Remainder: $${(cents/100).toFixed(2)}</div>`;
        }
        
        if (!hasItems && cents > 0) {
            html = `<div style="color:var(--sub-text); font-style:italic;">Cannot break with rules.</div>`;
        }

        resDiv.innerHTML = html;
    }

    function renderGuide(inventory) {
        const needList = document.getElementById('bank-need-list');
        const t = i18n[currentLang];
        needList.innerHTML = "";
        Object.keys(maxLimits).sort((a,b)=>b-a).forEach(v => {
            let actual = inventory[v] || 0;
            let max = maxLimits[v];
            if(actual < max) {
                needList.innerHTML += `<li><span>$${v}</span> <span>${t.target}<b>${max}</b> <small style="color:var(--danger)">(${t.missing}: ${max-actual})</small></span></li>`;
            } else {
                needList.innerHTML += `<li><span>$${v}</span> <small style="color:var(--secondary)">${t.ok}</small></li>`;
            }
        });
    }

    function resetForm() {
        if(confirm(i18n[currentLang].confirmReset)) {
            document.querySelectorAll('input[type="number"]').forEach(i => { 
                if(i.id !== 'target-safe' && i.id !== 'break-amount') i.value = ''; 
            });
            document.getElementById('break-result').innerHTML = ''; 
            document.getElementById('break-amount').value = '';
            calculate();
        }
    }
    setup();
</script>
</body>
</html>